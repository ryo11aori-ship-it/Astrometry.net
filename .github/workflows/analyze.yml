name: Build and Analyze Star Photo

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build-and-run:
    runs-on: windows-latest

    steps:
    # 1. コードのチェックアウト
    - name: Checkout repository
      uses: actions/checkout@v4

    # === 【追加】 デバッグ：全ファイルとディレクトリ構造を表示 ===
    # これでファイル名が微妙に違うのか、場所が違うのかが確定します
    - name: DEBUG - List ALL Files
      run: |
        Write-Host "--- Current Directory Content ---"
        Get-ChildItem -Recurse | Select-Object FullName, Length
        Write-Host "---------------------------------"
        
        Write-Host "--- Searching for any JPG/PNG ---"
        Get-ChildItem -Recurse -Include *.jpg,*.jpeg,*.png
        Write-Host "---------------------------------"

    # 2. 画像ファイルの存在確認
    - name: Check for starphoto
      run: |
        $img = Get-ChildItem -Filter "starphoto.*" -Recurse
        if ($img) {
            Write-Host "Found image at: $($img.FullName)"
        } else {
            Write-Error "CRITICAL: starphoto image is strictly NOT found in $PWD"
        }

    # 3. Python環境のセットアップ
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    # 4. 依存ライブラリのインストール
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests pyinstaller

    # 5. Windowsアプリ(exe)の作成
    - name: Build EXE with PyInstaller
      run: |
        pyinstaller --onefile --clean solve_sky.py

    # 6. アプリの実行と結果表示
    - name: Run the Star Analysis App
      run: |
        Copy-Item dist\solve_sky.exe .
        .\solve_sky.exe
